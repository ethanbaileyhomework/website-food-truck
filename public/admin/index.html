<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Content Manager</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        color-scheme: light dark;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      }
      body.cms-error-visible {
        min-height: 100vh;
        display: grid;
        place-items: center;
        background: #f3f4f6;
      }
      body.cms-error-visible .cms-error {
        max-width: 420px;
        padding: 1.5rem;
        border-radius: 0.75rem;
        background: white;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.15);
        color: #111827;
      }
      body.cms-error-visible .cms-error h1 {
        margin: 0 0 0.5rem;
        font-size: 1.5rem;
      }
      body.cms-error-visible .cms-error p {
        margin: 0.25rem 0 0;
        line-height: 1.5;
      }
      @media (prefers-color-scheme: dark) {
        body.cms-error-visible {
          background: #0f172a;
        }
        body.cms-error-visible .cms-error {
          background: #1e293b;
          color: #e2e8f0;
          box-shadow: 0 10px 30px rgba(8, 47, 73, 0.35);
        }
      }
    </style>
  </head>
  <body>
    <script>
      window.CMS_MANUAL_INIT = true;
    </script>
    <script src="https://unpkg.com/netlify-cms@^2.10.0/dist/netlify-cms.js"></script>
    <script>
      (function () {
        function renderError(message) {
          document.body.classList.add("cms-error-visible");
          var container = document.createElement("div");
          container.className = "cms-error";
          container.innerHTML =
            '<h1>Configuration error</h1>' +
            '<p>' +
            (message || "Unable to load the content manager configuration.") +
            '</p>' +
            '<p>Please try again later or contact the site administrator.</p>';
          document.body.innerHTML = "";
          document.body.appendChild(container);
        }

        async function loadConfig() {
          var response = await fetch("/api/admin/config", { cache: "no-store" });
          if (!response.ok) {
            throw new Error("Failed to load CMS configuration (" + response.status + ").");
          }
          return response.json();
        }

        async function initialiseCMS() {
          try {
            var config = await loadConfig();
            if (!window.CMS || typeof window.CMS.init !== "function") {
              throw new Error("Netlify CMS failed to initialise.");
            }
            window.CMS.init({ config: config });
          } catch (error) {
            console.error("Failed to initialise Netlify CMS", error);
            renderError(error && error.message ? error.message : "Unexpected error.");
          }
        }

        if (document.readyState === "complete") {
          initialiseCMS();
        } else {
          window.addEventListener("load", initialiseCMS, { once: true });
        }
      })();
    </script>
  </body>
</html>
